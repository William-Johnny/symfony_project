{% extends 'base.html.twig' %}

{% block title %}{{ task.name }}{% endblock %}

{% block body %}
<style>
    :root {
        --bg: #f8fafc;
        --card: #ffffff;
        --border: #e2e8f0;
        --primary: #4f46e5;
        --primary-hover: #4338ca;
        --text-main: #1e293b;
        --text-muted: #64748b;
        --success: #16a34a;
        --warning: #f59e0b;
        --danger: #dc2626;
    }

    body {
        background-color: var(--bg);
        font-family: "Inter", sans-serif;
        color: var(--text-main);
    }

    .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.05);
    }

    .card-title {
        font-weight: 600;
        font-size: 24px;
    }

    .task-meta {
        color: var(--text-muted);
        font-size: 14px;
    }

    .section-box {
        background: #f1f5f9;
        padding: 16px;
        border-radius: 12px;
        font-size: 14px;
    }

    .badge-modern {
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 12px;
    }

    .level-easy { background: #dcfce7; color: var(--success); }
    .level-medium { background: #fef3c7; color: var(--warning); }
    .level-hard { background: #fee2e2; color: var(--danger); }

    .btn-modern {
        background-color: var(--primary);
        color: white;
        border-radius: 10px;
        padding: 8px 14px;
        border: none;
        transition: 0.2s ease;
    }

    .btn-modern:hover {
        background-color: var(--primary-hover);
    }

    .subtask-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        margin-bottom: 12px;
        transition: 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .subtask-card:hover {
        box-shadow: 0 6px 18px rgba(0,0,0,0.05);
        transform: translateY(-2px);
    }

    .subtask-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .subtask-title {
        font-weight: 600;
        font-size: 16px;
    }

    .subtask-meta {
        font-size: 12px;
        color: var(--text-muted);
    }

    .assigned-you {
        color: var(--primary);
        font-weight: 500;
        font-size: 13px;
    }

    .unassigned {
        color: var(--danger);
        font-size: 13px;
    }

    select.form-select {
        border-radius: 10px;
    }

    .divider {
        margin: 30px 0;
        border-top: 1px solid var(--border);
    }

    #backBtn{
        color: var(--primary);
        text-decoration: none;
        font-size: 20px;
    }

</style>
<div class="container mt-4">
    <div class="card shadow-sm">
        <a href="/home/not_done" id="backBtn">
            <-
        </a>
        <div class="card-body">

            <h2 class="card-title mb-2">
                {{ task.name }}
                <span class="badge-modern level-{{ task.level }}">
                    {{ task.level }}
                </span>
            </h2>

            <div class="task-meta mb-4">
                Created by <strong>{{ task.createdBy.username }}</strong>
                on {{ task.createdAt|date('M d, Y H:i') }}
            </div>

            <div class="mb-4">
                <h5>Description</h5>
                <div class="section-box">
                    {{ task.description|nl2br }}
                </div>
            </div>

            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5>Assigned To</h5>

                    {% if task.assignedTo %}
                        <span class="badge bg-primary">
                            {{ task.assignedTo.username }}
                        </span>
                    {% else %}
                        <span class="text-muted">Unassigned</span>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    <form method="post"
                          action="{{ path('task_assign', {'id': task.id}) }}">

                        <div class="input-group">
                            <select name="assignee_id"
                                    class="form-select">

                                <option value="">-- Select User --</option>

                                {% for user in users %}
                                    <option value="{{ user.id }}"
                                        {% if task.assignedTo and task.assignedTo.id == user.id %}
                                            selected
                                        {% endif %}
                                    >
                                        {{ user.username }}
                                    </option>
                                {% endfor %}
                            </select>

                            <button type="submit" class="btn-modern">
                                Assign
                            </button>
                        </div>

                        <input type="hidden"
                               name="_token"
                               value="{{ csrf_token('assign_task_' ~ task.id) }}">
                    </form>
                </div>
            </div>

            <h5 class="mb-3">Subtasks</h5>

            {% for item in task.childTask %}
                <div class="subtask-card">

                    <div class="subtask-header">
                        <a href="{{ path('task_detail', {id: item.id}) }}"
                        class="subtask-title text-decoration-none text-dark">
                            {{ item.name }}
                        </a>

                        <span class="badge-modern level-{{ item.level }}">
                            {{ item.level }}
                        </span>
                    </div>

                    <div class="subtask-meta">
                        by {{ item.createdBy.username }}
                        â€¢ {{ item.createdAt|date('M d, Y') }}
                    </div>

                    <div class="text-muted">
                        {{ item.description }}
                    </div>

                    {% if item.assignedTo %}
                        {% if item.assignedTo.username == username %}
                            <div class="assigned-you">
                                Assigned to you
                            </div>
                        {% else %}
                            <div class="subtask-meta">
                                Assigned to {{ item.assignedTo.username }}
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="unassigned">
                            Not assigned
                        </div>
                    {% endif %}

                    <form method="post"
                        action="{{ path('task_delete', {id: item.id}) }}">
                        <button type="submit" class="text-danger">
                            Delete
                        </button>
                    </form>

                </div>
            {% else %}
                <p class="text-muted">No subtasks for this one.</p>
            {% endfor %}

            <div id="subtaskFormContainer" style="display:none;">
                <h1>Create new subTask</h1>

                {{ form_errors(subtaskForm) }}

                {{ form_start(subtaskForm) }}
                    {{ form_row(subtaskForm.name) }}
                    {{ form_row(subtaskForm.description) }}
                    {{ form_row(subtaskForm.level) }}


                    <button type="submit" class="btn">Add</button>
                {{ form_end(subtaskForm) }}
            </div>

            <button type="submit" class="btn-modern" id='subtaskBtn'>
                Add Subtask
            </button>

        </div>
    </div>

</div>
<script>
    document.getElementById('subtaskBtn').addEventListener('click', function() {
        const container = document.getElementById('subtaskFormContainer');
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
    });
</script>
{% endblock %}
